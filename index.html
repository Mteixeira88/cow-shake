<html>

<head>
    <title>Cow Shake game</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans&display=swap" rel="stylesheet">
</head>

<body>
    <div class="score">
        <p id="score">You don't have a score</p>
    </div>
    <div id="body" class="body">
        <button id="button" class="button" onclick="shaking()">Restart</button>
    </div>
    <div class="score">
        <p id="instantScore">Shake to milk the cow</p>
    </div>
</body>
<script src="shake.js"></script>
<script>
    var shakeEvent = new Shake({ threshold: 25, timeout: 500 });
    var finish = false;
    var timingOver = undefined;
    var time = undefined;
    var finalTime = 0;
    var shakes = 0;
    var image = './assets/cow_init.gif';
    var imageInit = './assets/cow_init.gif';
    var imageShaking = './assets/cow_shake.gif';
    var imageEnd = './assets/cow_end.gif';

    function isMobile() {
        if (/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        }
        return false;
    }

    function shaking() {
        shakes = 0;
        finalTime = 0;
        var bodyShape = document.getElementById('body');
        var score = document.getElementById('score');
        var instantScore = document.getElementById('instantScore');
        instantScore.innerText = 'Shake phone to milk the cow';
        var button = document.getElementById('button');
        image = imageInit;
        button.style.display = 'none';
        if (localStorage.getItem('scoreCow')) {
            score.innerText = 'Highest score: ' + localStorage.getItem('scoreCow') + ' shakes';
        }
        console.log(shakeEvent);
        bodyShape.style.backgroundImage = 'url(' + image + ')';
        if (isMobile()) {
            shakeEvent.start();
            window.addEventListener('shake', () => {
                clearTimeout(timingOver);
                if (image !== imageShaking) {
                    image = imageShaking;
                    bodyShape.style.backgroundImage = 'url(' + imageShaking + ')';
                }
                if (shakes === 0) {
                    time = +new Date();
                }
                shakes += 1
                timingOver = setTimeout(() => {
                    clearTimeout(timingOver);
                    shakeEvent.stop();
                    bodyShape.style.backgroundImage = 'url(' + imageEnd + ')';
                    button.style.display = 'block';
                    finalTime = Math.round((+new Date() - time) / 1000);
                    if (!localStorage.getItem('scoreCow') || shakes > parseInt(localStorage.getItem('scoreCow'))) {
                        localStorage.setItem('scoreCow', shakes)
                        score.innerText = 'New score: ' + localStorage.getItem('scoreCow') + ' shakes';
                    }
                    instantScore.innerText = 'Your score: ' + shakes + ' shakes in ' + finalTime + ' seconds';
                }, 1000)
            }, false);
        }
    }

    document.addEventListener('DOMContentLoaded', shaking, false);
</script>

</html>
